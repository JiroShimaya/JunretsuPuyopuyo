<!DOCTYPE html>

	 <!-- jquery cdn -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<!-- jquery ui cdn -->
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

	<!-- bootstrap4 cdn (jsはjqueryよりあとに読み込む)-->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<title>純烈落ち物パズル</title>
	<meta name="description" content="純烈落ち物パズル" />
	<meta name="author" content="Jiro Shimaya" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
	<div class="main"></div>
	<div class="supplement-area">
		<br><br><br><br>
		<div>写真拝借元：<a href="http://junretsu-official.com/profile.php">http://junretsu-official.com/profile.php</a></div>
		<div>--------</div>
		<div>更新履歴</div>
		<div>2020/04/26 Webページ公開</div>
	</div>
</body>
<script>
const shuffle = ([...array]) => {
	for (let i = array.length - 1; i >= 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[array[i], array[j]] = [array[j], array[i]];
	}
	return array;
}
const getRandomInt = max => Math.floor(Math.random()*max);
const getRandomFromList = ary => ary[Math.floor(Math.random()*ary.length)]
const getSum = ary => ary.reduce((prev,v)=>prev+v,0);
const isSmartPhone = () => {  
	  if (navigator.userAgent.match(/iPhone|Android.+Mobile/)) {  
	    return true;  
	  } else {  
	    return false;  
	  }  
	}  
//ダブルタップ無効
let lastTouch = 0;
document.addEventListener('touchend', event => {
  const now = window.performance.now();
  if (now - lastTouch <= 500) {
    event.preventDefault();
  }
  lastTouch = now;
}, true);
</script>
<script>
const BLOCK_WIDTH = 50;
const COLUMN = 5;
const ROW = 8;
const AREA_WIDTH = BLOCK_WIDTH*COLUMN;
const AREA_HEIGHT = BLOCK_WIDTH*ROW;

const getMatrix = (init=null) => {
	const array = [];
	for(let i=0;i<COLUMN;i++){
		const a = new Array(ROW);
		a.fill(init);
		array.push(a);
	}
	return array;
}
const MATRIX = getMatrix(0);
const BLOCK_MATRIX = getMatrix(null);



const area = $('.main');
area.width(String(AREA_WIDTH)+'px');
area.height(String(AREA_HEIGHT)+'px');
area.css('background-color','#eee');
area.css('position','relative');
const members = ["sakai.jpg","gogami.jpg","shirakawa.jpg","odai.jpg"]
const member_ids = [1,10,100,1000]

const pict_dir = "pict/";

const judge = () => {
	const judge_matrix = getMatrix(false);
	
	const member_id_sum = member_ids.reduce((prev,v)=>prev+v,0);
	const num = member_ids.length;
	
	//check vertically
	for(let i=0;i<MATRIX.length;i++){
		const c = MATRIX[i];
		for(let j=0;j<c.length+1-num;j++){
			const sum = c.slice(j,j+num).reduce((prev,v)=>prev+v,0);
			//console.log(sum);
			if(sum == member_id_sum){
				for(let k=0;k<num;k++){
					judge_matrix[i][j+k]=true;
				}
				
			}
		}
	}
	
	//check horizntary
	for(let i=0;i<MATRIX.length+1-num;i++){
		for(let j=0;j<MATRIX[i].length;j++){
			const sum = MATRIX.slice(i,i+num)
						.reduce((prev,v)=>prev+v[j],0);
			if(sum == member_id_sum){
				for(let k=0;k<num;k++){
					judge_matrix[i+k][j]=true;
				}
			}
		}
	}
	console.log('judge');
	//console.log(judge_matrix);
	
	//remove block
	for(let i=0;i<BLOCK_MATRIX.length;i++){
		for(let j=0;j<BLOCK_MATRIX[i].length;j++){
			if(judge_matrix[i][j] == true){
				BLOCK_MATRIX[i][j].remove();
			}
		}
	}
	
	//重力を適用
	applyGravity();
}
const applyGravity = () => {
	const move_matrix = getMatrix(0);
	for(let i=0;i<BLOCK_MATRIX.length;i++){
		const c = BLOCK_MATRIX[i];
		for(let j=c.length-1;j>=1;j--){
			if(c[j] === null){
				for(let k=0;k<j;k++){
					move_matrix[i][k]+=1;
				}
			}
		}
	}
	
	console.log('apply gravity');
	console.log(move_matrix);
	let isMoved = false;
	for(let i=0;i<BLOCK_MATRIX.length;i++){
		const c=BLOCK_MATRIX[i];
		for(let j=c.length-2;j>=0;j--){
			if(c[j] === null)continue;
			for(let k=0;k<move_matrix[i][j];k++){
				c[j].moveDown();
				isMoved = true;
			}
		}
	}
	if(isMoved)judge();
}

const getBlock = () => {
	const id = getRandomInt(members.length);
	const file = pict_dir+members[id];
	const member_id = member_ids[id];
	const img = $('<img>');
	img.appendTo(area);
	img.attr('src',file);
	img.css('position','absolute');
	img.width(String(BLOCK_WIDTH)+'px');
	
	
	let top = 0;
	let left = getRandomInt(COLUMN);
	const set = (l,t) => {
		if(l<0 || t<0)return false;
		if(l>=COLUMN || t>=ROW)return false;
		if(MATRIX[l][t] > 0){
			return false;
		} 
		img.css('left',l*BLOCK_WIDTH);
		img.css('top',t*BLOCK_WIDTH);
		//console.log(MATRIX);
		MATRIX[left][top] = 0;
		BLOCK_MATRIX[left][top] = null;
		MATRIX[l][t] = member_id;
		BLOCK_MATRIX[l][t] = utils;
		top = t;
		left = l;
		return true;
	}
	const remove = () => {
		img.remove();
		MATRIX[left][top] = 0;
		BLOCK_MATRIX[left][top] = null;	
	}
	
	const moveDown = () => set(left,top+1);
	const moveToBottom = () => {
		const c = BLOCK_MATRIX[left];
		let fall_range = 0;
		for(let i=top+1;i<BLOCK_MATRIX.length;i++){
			if(c[i] === null)fall_rage+=1;
			else if(c[i] !== null)break;
		}
		for(let i=0;i<fall_range;i++)moveDown();
	}
	const fall = () => {
		if(moveDown()==false){
			$('body').off('keydown');
			clearInterval(interval);
			judge();
			getBlock();						
		}
	}
	const moveLeft = () => set(left-1,top);
	const moveRight = () => set(left+1,top);		
	const utils = {
			remove: remove,
			moveDown: moveDown,
			moveToBottom:moveToBottom
	}
	if(set(left,top)==false){
		alert('game over');
		return false;
	}

	const interval = setInterval(()=>{
		fall();
	},1000);
	$('body').keydown(e=>{
		switch(e.keyCode){
		case 37: //←
			console.log("keydown ←");
			e.preventDefault();
			moveLeft();
			break;
		case 38: //↑
			console.log("keydown ↑");
			e.preventDefault();
			break;
		case 39: //→
			console.log("keydown →");
			e.preventDefault();
			moveRight();
			break;
		case 40: //↓
			console.log("keydown ↓");
			e.preventDefault();
			fall();
			break;
		}
	});
}
getBlock();


</script>